{"version":3,"file":"0.ea84b87275aa2c2c174d.hot-update.js","sources":["webpack:///src/server.js"],"sourcesContent":["import App from './App';\nimport React from 'react';\nimport { StaticRouter } from 'react-router-dom';\nimport express from 'express';\nimport { renderToString } from 'react-dom/server';\nvar router = express.Router();\nvar ldap = require('ldapjs');\nvar promise = require('bluebird');\n\nfunction ldapSearch() {\n  \n  //ldap.Attribute.settings.guid_format = ldap.GUID_FORMAT_B;\n  var client = ldap.createClient({\n    url: 'ldap://ldap/cn=cldap,ou=services,dc=cnam,dc=fr',\n    timeout: 5000,\n    connectTimeout: 10000\n});\nvar opts = {\nfilter: '(&(uid=lelongj))',\nscope: 'sub',\nattributes: ['uid','givenname']\n};\n\nconsole.log('--- going to try to connect user ---');\n\ntry {\n  client.bind('', '', function (error) {\n      \n    if(error){\n      console.log('ERREUR');\n      console.log(error.message);\n          client.unbind(function(error) {if(error){console.log(error.message);} else{console.log('client disconnected');}});\n      } else {\n          console.log('connected');\n          client.search('ou=people,o=personnel,dc=cnam,dc=fr', opts, function(error, search) {\n              console.log('Searching.....');\n\n              search.on('searchEntry', function(entry) {\n                if(entry.object){\n                      console.log('entry: %j ' + JSON.stringify(entry.object));\n                  }\n                  return entry.object;\n              });\n\n              search.on('error', function(error) {\n                  console.error('error: ' + error.message);\n              });\n\n              client.unbind(function(error) {if(error){console.log(error.message);} else{console.log('client disconnected');}});\n          });\n      }\n  });\n} catch(error){\nconsole.log(error);\n  client.unbind(function(error) {if(error){console.log(error.message);} else{console.log('client disconnected');}});\n  \n}\n}\n\n\n\n//var client = ldap.createClient({url: 'ldap://ldap/cn=admin,dc=cnam,dc=fr'});\nvar client = ldap.createClient({url: 'ldap://ldap.cnam.fr/cn=cldap,ou=services,dc=cnam,dc=fr'});\nvar uid;\n\npromise.promisifyAll(client);\n\nfunction searchPromise(res, notfoundtext) {\n  return new Promise(function(resolve, reject) {\n    var found = false;\n    res.on('searchEntry', function(entry) {\n      found = true;\n      resolve(entry);\n    });\n    res.on('error', function(e) {\n      reject(e.message);\n    });\n    res.on('end', function() {\n      if (!found) {\n        reject(notfoundtext);\n      } \n    });\n  });\n}\nvar credentials = {password:''};\n\nasync function trouverPersonnel() {\n  //await client.bindAsync('cn=admin,dc=cnam,dc=fr', 'admin')\n  await client.bindAsync('ou=people,o=personnel,dc=cnam,dc=fr', 'admin')\n  .then() // if it works, call doSearch\n  .catch(function (err) { // if bind fails, handle it\n    console.error('Error on bind', err)\n  });\n\n  return client.searchAsync('ou=people,o=personnel,dc=cnam,dc=fr', {filter: '(&(uid=lelongj))', scope: 'sub',attributes: ['uid','sn','givenname']})\n  .then(function(res) {\n    return searchPromise(res, 'User isn\\'t exists.');\n  })\n  .then(function (entry) {\n    uid = entry.object.uid;\n    return entry.object;\n    //return client.bindAsync(entry.object.dn, credentials.password);\n  })\n  /*\n  .then(function() {\n    return client.searchAsync('cn=cldap,ou=services,dc=cnam,dc=fr', {filter: '(&(uid=lelongj))', scope: 'sub',attributes: ['uid','givenname']});\n  })\n  .then(function(res) {\n    return searchPromise(res, 'User is not in group ');\n  })\n  .then(function() {\n    console.log('All is ok');\n  })\n  .catch(function(message) {\n    console.log('Error:' + message);\n  })\n*/\n;\n\n}\nrouter.get('/',async function(req, res, next) {\n  //res.send('respond with a resource');\n  //const users = [{username: 'lelongj',id: 1}, {username: 'dupontd',id: 2}];\n  //return res.json(users);\n  //return res.json(await ldapSearch());\n  return res.json(await trouverPersonnel());\n\n});\n\nconst assets = require(process.env.RAZZLE_ASSETS_MANIFEST);\n\nconst server = express();\n\nserver.use('/users', router);\n\nserver\n  .disable('x-powered-by')\n  .use(express.static(process.env.RAZZLE_PUBLIC_DIR))\n  .get('/*', (req, res) => {\n    const context = {};\n    const markup = renderToString(\n      <StaticRouter context={context} location={req.url}>\n        <App />\n      </StaticRouter>\n    );\n\n    if (context.url) {\n      res.redirect(context.url);\n    } else {\n      res.status(200).send(\n        `<!doctype html>\n    <html lang=\"\">\n    <head>\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n        <meta charSet='utf-8' />\n        <title>Welcome to Razzle</title>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        ${assets.client.css\n          ? `<link rel=\"stylesheet\" href=\"${assets.client.css}\">`\n          : ''}\n        ${process.env.NODE_ENV === 'production'\n          ? `<script src=\"${assets.client.js}\" defer></script>`\n          : `<script src=\"${assets.client.js}\" defer crossorigin></script>`}\n    </head>\n    <body>\n        <div id=\"root\">${markup}</div>\n    </body>\n</html>`\n      );\n    }\n  });\n\nexport default server;\n\n\n\n// WEBPACK FOOTER //\n// src/server.js"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAPA;AAAA;AAUA;AACA;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AAjBA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;;;;;AAtFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AACA;AAHA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAmCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AADA;AACA;AAIA;AACA;AACA;AACA;AAoBA;AACA;AACA;AACA;;;;A","sourceRoot":""}